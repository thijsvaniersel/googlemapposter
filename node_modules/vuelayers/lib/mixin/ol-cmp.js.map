{"version":3,"file":"ol-cmp.js","sources":["src/mixin/ol-cmp.js"],"sourcesContent":["import debounce from 'debounce-promise'\nimport { interval as intervalObs } from 'rxjs/observable'\nimport { first as firstObs, skipWhile } from 'rxjs/operators'\nimport uuid from 'uuid/v4'\nimport { log } from '../util/log'\nimport { identity, isFunction } from '../util/minilo'\nimport identMap from './ident-map'\nimport rxSubs from './rx-subs'\nimport services from './services'\n\nconst VM_PROP = 'vm'\n\n/**\n * Basic ol component mixin.\n * todo try to subscribe to generic change event here and update rev according to internal ol counter\n */\nexport default {\n  VM_PROP,\n  mixins: [identMap, rxSubs, services],\n  props: {\n    id: {\n      type: [String, Number],\n      default: () => uuid(),\n    },\n  },\n  data () {\n    return {\n      rev: 0,\n    }\n  },\n  computed: {\n    cmpName () {\n      return this.$options.name\n    },\n    vmId () {\n      return [this.cmpName, this.id].filter(identity).join('-')\n    },\n    vmName () {\n      return [this.cmpName, this.id].filter(identity).join(' ')\n    },\n    olObjIdent () {\n      return this.selfIdent\n    },\n  },\n  methods: {\n    /**\n     * @return {Promise<void>}\n     * @protected\n     */\n    beforeInit () {},\n    /**\n     * @return {Promise<void>} Resolves when initialization completes\n     * @protected\n     */\n    async init () {\n      this._olObject = await this.instanceFactoryCall(this.olObjIdent, ::this.createOlObject)\n      this._olObject[VM_PROP] || (this._olObject[VM_PROP] = [])\n\n      if (!this._olObject[VM_PROP].includes(this)) { // for loaded from IdentityMap\n        this._olObject[VM_PROP].push(this)\n      }\n\n      ++this.rev\n    },\n    /**\n     * @return {module:ol/Object~BaseObject|Promise<module:ol/Object~BaseObject>}\n     * @protected\n     * @abstract\n     */\n    createOlObject () {\n      throw new Error('Not implemented method')\n    },\n    /**\n     * @return {void|Promise<void>}\n     * @protected\n     */\n    deinit () {\n      this.unsetInstances()\n\n      if (this._olObject) {\n        this._olObject[VM_PROP] = this._olObject[VM_PROP].filter(vm => vm !== this)\n        this._olObject = undefined\n      }\n    },\n    /**\n     * Redefine for easy call in child components\n     * @returns {Object}\n     * @protected\n     */\n    getServices () {\n      return this::services.methods.getServices()\n    },\n    /**\n     * @return {void|Promise<void>}\n     * @protected\n     */\n    mount () {\n      this.subscribeAll()\n    },\n    /**\n     * @return {void|Promise<void>}\n     * @protected\n     */\n    unmount () {\n      this.unsubscribeAll()\n    },\n    /**\n     * Refresh internal ol objects\n     * @return {Promise<void>}\n     */\n    refresh () {\n      if (this.$olObject == null) return Promise.resolve()\n\n      return new Promise(resolve => {\n        if (this.$olObject && isFunction(this.$olObject.changed)) {\n          this.$olObject.once('change', () => resolve())\n          this.$olObject.changed()\n        } else {\n          resolve()\n        }\n      })\n    },\n    /**\n     * Internal usage only in components that doesn't support refreshing.\n     * @return {Promise<void>}\n     * @protected\n     */\n    async remount () {\n      if (this.$olObject == null) return\n\n      await this.unmount()\n      await this.mount()\n    },\n    /**\n     * Only for internal purpose to support watching for properties\n     * for which OpenLayers doesn't provide setters.\n     * @return {Promise}\n     * @protected\n     */\n    async recreate () {\n      if (this.$olObject == null) return\n\n      await this.unmount()\n      await this.deinit()\n      await this.init()\n      await this.mount()\n    },\n    subscribeAll () {},\n  },\n  created () {\n    /**\n     * @type {module:ol/Object~BaseObject}\n     * @private\n     */\n    this._olObject = undefined\n    Object.defineProperties(this, {\n      $olObject: {\n        enumerable: true,\n        get: () => this._olObject,\n      },\n    })\n\n    this::defineLifeCyclePromises()\n    this::defineDebouncedHelpers()\n  },\n  async mounted () {\n    await this.$createPromise\n\n    this._mounted = true\n  },\n  async beforeDestroy () {\n    await this.$mountPromise\n\n    this._mounted = false\n  },\n  async destroyed () {\n    await this.$unmountPromise\n\n    this._destroyed = true\n  },\n}\n\nfunction defineLifeCyclePromises () {\n  const makeEventEmitter = event => () => {\n    this.$emit(event, this)\n\n    if (process.env.VUELAYERS_DEBUG) {\n      log(event, this.vmName)\n    }\n\n    return this\n  }\n  // create\n  this._createPromise = Promise.resolve(this.beforeInit())\n    .then(() => this.init())\n    .then(makeEventEmitter('created'))\n\n  // mount\n  const mountObs = intervalObs(1000 / 60)\n    .pipe(\n      skipWhile(() => this._mounted !== true),\n      firstObs(),\n    )\n  this._mountPromise = mountObs.toPromise(Promise)\n    .then(() => this.mount())\n    .then(makeEventEmitter('mounted'))\n\n  // unmount\n  const unmountObs = intervalObs(1000 / 60)\n    .pipe(\n      skipWhile(() => this._mounted !== false),\n      firstObs(),\n    )\n  this._unmountPromise = unmountObs.toPromise(Promise)\n    .then(() => this.unmount())\n    .then(makeEventEmitter('unmounted'))\n\n  // destroy\n  const destroyObs = intervalObs(1000 / 60)\n    .pipe(\n      skipWhile(() => this._destroyed !== true),\n      firstObs(),\n    )\n  this._destroyPromise = destroyObs.toPromise(Promise)\n    .then(() => this.deinit())\n    .then(makeEventEmitter('destroyed'))\n\n  Object.defineProperties(this, {\n    $createPromise: {\n      enumerable: true,\n      get: () => this._createPromise,\n    },\n    $mountPromise: {\n      enumerable: true,\n      get: () => this._mountPromise,\n    },\n    $unmountPromise: {\n      enumerable: true,\n      get: () => this._unmountPromise,\n    },\n    $destroyPromise: {\n      enumerable: true,\n      get: () => this._destroyPromise,\n    },\n  })\n}\n\nfunction defineDebouncedHelpers () {\n  const t = 1000 / 10\n  // bind debounced functions at runtime\n  // for each instance to avoid interfering between\n  // different instances\n  this.scheduleRefresh = debounce(function () {\n    return this.refresh()\n  }, t)\n  this.scheduleRemount = debounce(function () {\n    return this.remount()\n  }, t)\n  this.scheduleRecreate = debounce(function () {\n    return this.recreate()\n  }, t)\n}\n"],"names":["VM_PROP","mixins","identMap","rxSubs","services","props","id","type","String","Number","default","uuid","data","rev","computed","cmpName","$options","name","vmId","identity","join","vmName","olObjIdent","selfIdent","methods","beforeInit","init","instanceFactoryCall","createOlObject","_olObject","push","Error","deinit","unsetInstances","vm","undefined","getServices","mount","subscribeAll","unmount","unsubscribeAll","refresh","$olObject","resolve","isFunction","changed","once","remount","recreate","created","enumerable","get","defineLifeCyclePromises","defineDebouncedHelpers","mounted","$createPromise","_mounted","beforeDestroy","$mountPromise","destroyed","$unmountPromise","_destroyed","makeEventEmitter","event","$emit","process","env","VUELAYERS_DEBUG","log","_createPromise","then","mountObs","intervalObs","pipe","skipWhile","firstObs","_mountPromise","toPromise","unmountObs","_unmountPromise","destroyObs","_destroyPromise","$destroyPromise","t","scheduleRefresh","debounce","scheduleRemount","scheduleRecreate"],"mappings":"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"}