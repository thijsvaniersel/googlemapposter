{"version":3,"file":"features-container.js","sources":["src/mixin/features-container.js"],"sourcesContent":["import Collection from 'ol/Collection'\nimport Feature from 'ol/Feature'\nimport Vue from 'vue'\nimport { merge as mergeObs } from 'rxjs/observable'\nimport { debounceTime } from 'rxjs/operators'\nimport { getFeatureId, getObjectUid, initializeFeature, mergeFeatures } from '../ol-ext'\nimport { instanceOf } from '../util/assert'\nimport { forEach, isPlainObject } from '../util/minilo'\nimport projTransforms from './proj-transforms'\nimport rxSubs from './rx-subs'\nimport identMap from './ident-map'\nimport { observableFromOlEvent } from '../rx-ext'\n\nexport default {\n  mixins: [identMap, rxSubs, projTransforms],\n  computed: {\n    featureIds () {\n      if (!this.rev) return []\n\n      return this.getFeatures().map(getFeatureId)\n    },\n    featuresViewProj () {\n      if (!this.rev) return []\n\n      return this.getFeatures().map(::this.writeFeatureInViewProj)\n    },\n    featuresDataProj () {\n      if (!this.rev) return []\n\n      return this.getFeatures().map(::this.writeFeatureInDataProj)\n    },\n    featuresCollectionIdent () {\n      if (!this.olObjIdent) return\n\n      return this.makeIdent(this.olObjIdent, 'features_collection')\n    },\n  },\n  methods: {\n    /**\n     * @param {Array<(Feature|Vue|Object)>} features\n     * @return {void}\n     */\n    addFeatures (features) {\n      forEach(features, ::this.addFeature)\n    },\n    /**\n     * @param {Feature|Vue|Object} feature\n     * @return {void}\n     */\n    addFeature (feature) {\n      if (feature instanceof Vue) {\n        feature = feature.$feature\n      } else if (isPlainObject(feature)) {\n        feature = this.readFeatureInDataProj(feature)\n      }\n      instanceOf(feature, Feature)\n      initializeFeature(feature)\n\n      const foundFeature = this.getFeatureById(getFeatureId(feature))\n      if (foundFeature == null) {\n        this.$featuresCollection.push(feature)\n      } else {\n        mergeFeatures(foundFeature, feature)\n      }\n    },\n    /**\n     * @param {Array<(Feature|Vue|Object)>} features\n     * @return {void}\n     */\n    removeFeatures (features) {\n      forEach(features, ::this.removeFeature)\n    },\n    /**\n     * @param {Feature|Vue|Object} feature\n     * @return {void}\n     */\n    removeFeature (feature) {\n      feature = this.getFeatureById(getFeatureId(feature))\n      if (!feature) return\n\n      initializeFeature(feature)\n      this.$featuresCollection.remove(feature)\n    },\n    /**\n     * @return {void}\n     */\n    clearFeatures () {\n      this.$featuresCollection.clear()\n    },\n    /**\n     * @param {string|number} featureId\n     * @return {Feature|undefined}\n     */\n    getFeatureById (featureId) {\n      // todo add hash {featureId => featureIdx, ....}\n      return this.$featuresCollection.getArray().find(feature => {\n        return getFeatureId(feature) === featureId\n      })\n    },\n    /**\n     * @return {Feature[]}\n     */\n    getFeatures () {\n      return this.$featuresCollection.getArray()\n    },\n    /**\n     * @return {Collection<Feature>>}\n     */\n    getFeaturesCollection () {\n      return this._featuresCollection\n    },\n    /**\n     * @returns {Object}\n     * @protected\n     */\n    getServices () {\n      const vm = this\n\n      return {\n        get featuresContainer () { return vm },\n      }\n    },\n  },\n  created () {\n    this._featuresCollection = this.instanceFactoryCall(this.featuresCollectionIdent, () => new Collection())\n    this._featureSubs = {}\n\n    this::defineServices()\n    this::subscribeToCollectionEvents()\n  },\n}\n\nfunction defineServices () {\n  Object.defineProperties(this, {\n    $featuresCollection: {\n      enumerable: true,\n      get: this.getFeaturesCollection,\n    },\n  })\n}\n\nfunction subscribeToCollectionEvents () {\n  const adds = observableFromOlEvent(this.$featuresCollection, 'add')\n  this.subscribeTo(adds, ({ element }) => {\n    const elementUid = getObjectUid(element)\n    const propChanges = observableFromOlEvent(element, 'propertychange')\n    const otherChanges = observableFromOlEvent(element, 'change')\n    const featureChanges = mergeObs(propChanges, otherChanges).pipe(\n      debounceTime(1000 / 60)\n    )\n\n    this._featureSubs[elementUid] = this.subscribeTo(featureChanges, () => {\n      ++this.rev\n    })\n\n    ++this.rev\n\n    this.$nextTick(() => {\n      this.$emit('add:feature', element)\n    })\n  })\n\n  const removes = observableFromOlEvent(this.$featuresCollection, 'remove')\n  this.subscribeTo(removes, ({ element }) => {\n    const elementUid = getObjectUid(element)\n    if (this._featureSubs[elementUid]) {\n      this.unsubscribe(this._featureSubs[elementUid])\n      delete this._featureSubs[elementUid]\n    }\n\n    ++this.rev\n\n    this.$nextTick(() => {\n      this.$emit('remove:feature', element)\n    })\n  })\n}\n"],"names":["mixins","identMap","rxSubs","projTransforms","computed","featureIds","rev","getFeatures","getFeatureId","featuresViewProj","writeFeatureInViewProj","featuresDataProj","writeFeatureInDataProj","featuresCollectionIdent","olObjIdent","makeIdent","methods","addFeatures","features","forEach","addFeature","feature","Vue","$feature","isPlainObject","readFeatureInDataProj","instanceOf","Feature","initializeFeature","foundFeature","getFeatureById","$featuresCollection","push","mergeFeatures","removeFeatures","removeFeature","remove","clearFeatures","clear","featureId","getArray","getFeaturesCollection","_featuresCollection","getServices","vm","featuresContainer","created","instanceFactoryCall","Collection","_featureSubs","defineServices","subscribeToCollectionEvents","enumerable","get","adds","observableFromOlEvent","subscribeTo","element","elementUid","getObjectUid","propChanges","otherChanges","featureChanges","mergeObs","pipe","debounceTime","$nextTick","$emit","removes","unsubscribe"],"mappings":"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"}