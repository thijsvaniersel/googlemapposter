{"version":3,"file":"tile-source.js","sources":["src/mixin/tile-source.js"],"sourcesContent":["import { createTileUrlFunction } from 'ol-tilecache'\nimport {\n  CACHE_SIZE,\n  createExtentFromProjection,\n  createXyzGrid,\n  EPSG_3857,\n  MAX_ZOOM,\n  MIN_ZOOM,\n  PIXEL_RATIO,\n  REPROJ_ERR_THRESHOLD,\n  TILE_SIZE,\n} from '../ol-ext'\nimport { observableFromOlEvent } from '../rx-ext'\nimport { hasSource } from '../util/assert'\nimport { isEqual, isString, pick, replaceTokens } from '../util/minilo'\nimport { makeWatchers } from '../util/vue-helpers'\nimport source from './source'\nimport withUrl from './with-url'\n\nexport default {\n  mixins: [source, withUrl],\n  props: {\n    cacheSize: {\n      type: Number,\n      default: CACHE_SIZE,\n    },\n    crossOrigin: String,\n    maxZoom: {\n      type: Number,\n      default: MAX_ZOOM,\n    },\n    minZoom: {\n      type: Number,\n      default: MIN_ZOOM,\n    },\n    opaque: Boolean,\n    projection: {\n      type: String,\n      default: EPSG_3857,\n    },\n    reprojectionErrorThreshold: {\n      type: Number,\n      default: REPROJ_ERR_THRESHOLD,\n    },\n    tilePixelRatio: {\n      type: Number,\n      default: PIXEL_RATIO,\n    },\n    tileSize: {\n      type: Array,\n      default: () => [TILE_SIZE, TILE_SIZE],\n      validator: value => value.length === 2,\n    },\n    /**\n     * @type {module:ol/Tile~LoadFunction}\n     */\n    tileLoadFunction: Function,\n    tileKey: String,\n    /**\n     * URL template or custom tile URL function.\n     * @type {string|module:ol/Tile~UrlFunction}\n     */\n    url: {\n      type: [String, Function],\n      required: true,\n    },\n    /**\n     * Duration of the opacity transition for rendering. To disable the opacity transition, pass `0`.\n     * @type {number}\n     */\n    transition: Number,\n  },\n  computed: {\n    /**\n     * @type {string|undefined}\n     */\n    urlTmpl () {\n      if (!isString(this.url)) {\n        return\n      }\n\n      return replaceTokens(this.url, pick(this, this.urlTokens))\n    },\n    /**\n     * @returns {function}\n     */\n    urlFunc () {\n      if (!this.url) {\n        return\n      }\n\n      let url\n      if (this.urlTmpl != null) {\n        const extent = createExtentFromProjection(this.projection)\n        url = createTileUrlFunction(this.urlTmpl, this._tileGrid, extent)\n      } else {\n        url = this.url\n      }\n\n      return url\n    },\n    tileGridIdent () {\n      if (!this.olObjIdent) return\n\n      return this.makeIdent(this.olObjIdent, 'tile_grid')\n    },\n  },\n  methods: {\n    createTileGrid () {\n      return createXyzGrid({\n        extent: createExtentFromProjection(this.projection),\n        maxZoom: this.maxZoom,\n        minZoom: this.minZoom,\n        tileSize: this.tileSize,\n      })\n    },\n    /**\n     * @return {Promise}\n     * @protected\n     */\n    init () {\n      /**\n       * @type {module:ol/Tile~UrlFunction}\n       * @protected\n       */\n      this._tileGrid = this.instanceFactoryCall(this.tileGridIdent, ::this.createTileGrid)\n\n      return this::source.methods.init()\n    },\n    /**\n     * @return {void|Promise<void>}\n     * @protected\n     */\n    deinit () {\n      this._tileGrid = undefined\n\n      return this::source.methods.deinit()\n    },\n    /**\n     * @return {void}\n     * @protected\n     */\n    mount () {\n      this::source.methods.mount()\n    },\n    /**\n     * @return {void}\n     * @protected\n     */\n    unmount () {\n      this::source.methods.unmount()\n    },\n    subscribeAll () {\n      this::source.methods.subscribeAll()\n      this::subscribeToSourceEvents()\n    },\n  },\n  watch: {\n    opaque (value) {\n      if (!this.$source || value === this.$source.getOpaque()) {\n        return\n      }\n\n      this.scheduleRecreate()\n    },\n    tilePixelRatio (value) {\n      if (!this.$source || value === this.$source.getOpaque()) {\n        return\n      }\n\n      this.scheduleRecreate()\n    },\n    tileKey (value) {\n      if (!this.$source || value === this.$source.getKey()) {\n        return\n      }\n\n      this.$source.setKey(value)\n    },\n    tileLoadFunction (value, prevValue) {\n      if (!this.$source || isEqual(value, prevValue)) return\n\n      this.$source.setTileLoadFunction(value)\n    },\n    urlFunc (value) {\n      if (!this.$source) return\n\n      this.$source.setTileUrlFunction(value)\n      this.scheduleRefresh()\n    },\n    ...makeWatchers([\n      'cacheSize',\n      'crossOrigin',\n      'reprojectionErrorThreshold',\n      'transition',\n      'maxZoom',\n      'minZoom',\n      'tileSize',\n    ], () => function () {\n      this.scheduleRecreate()\n    }),\n  },\n}\n\nfunction subscribeToSourceEvents () {\n  hasSource(this)\n\n  const events = observableFromOlEvent(this.$source, [\n    'tileloadstart',\n    'tileloadend',\n    'tileloaderror',\n  ])\n\n  this.subscribeTo(events, evt => {\n    this.$emit(evt.type, evt)\n  })\n}\n"],"names":["mixins","source","withUrl","props","cacheSize","type","Number","default","CACHE_SIZE","crossOrigin","String","maxZoom","MAX_ZOOM","minZoom","MIN_ZOOM","opaque","Boolean","projection","EPSG_3857","reprojectionErrorThreshold","REPROJ_ERR_THRESHOLD","tilePixelRatio","PIXEL_RATIO","tileSize","Array","TILE_SIZE","validator","value","length","tileLoadFunction","Function","tileKey","url","required","transition","computed","urlTmpl","isString","replaceTokens","pick","urlTokens","urlFunc","extent","createExtentFromProjection","createTileUrlFunction","_tileGrid","tileGridIdent","olObjIdent","makeIdent","methods","createTileGrid","createXyzGrid","init","instanceFactoryCall","deinit","undefined","mount","unmount","subscribeAll","subscribeToSourceEvents","watch","$source","getOpaque","scheduleRecreate","getKey","setKey","prevValue","isEqual","setTileLoadFunction","setTileUrlFunction","scheduleRefresh","makeWatchers","hasSource","events","observableFromOlEvent","subscribeTo","evt","$emit"],"mappings":"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"}